#include <stdio.h>
#include <windows.h>

#define okay(MSG, ...) printf("\n[+] " MSG, ##__VA_ARGS__)
#define info(MSG, ...) printf("\n[*] " MSG, ##__VA_ARGS__)
#define warn(MSG, ...) printf("\n[-] " MSG, ##__VA_ARGS__)

/* 
* Memory management Basics
* Resources: 
* * https://stackoverflow.com/questions/872072/whats-the-differences-between-virtualalloc-and-heapalloc 
* * https://learn.microsoft.com/en-us/windows/win32/memory/comparing-memory-allocation-methods
*/

int main() {

	CHAR* msg = "Select allocation method:\n"
		"	[1] malloc\n"
		"	[2] HeapAlloc\n"
		"	[3] LocalAlloc\n"
		"	[4] VirtualAlloc\n"
		">> "; 
	printf(msg);
	
	CHAR input[256]; 
	INT  mode;
	if (fgets(input, sizeof(input), stdin)) {
		if (sscanf_s(input, "%d", &mode)) {
			okay("Using mode %d.", mode);
		}
		else { return ERROR; }
	}
	else { return ERROR;  }

	PVOID pAddress = NULL; 
	CHAR* cString = "Malware development is cool.";

	switch (mode) {
	case 1:
		/*
		* Memory allocation with malloc
		* * https://en.cppreference.com/w/c/memory/malloc
		*/
		pAddress = malloc(100);
		memcpy(pAddress, cString, strlen(cString));
		info("Address allocated with malloc: 0x%p\n", pAddress);
		printf(pAddress);
		
		free(pAddress);
		info("Memory deallocated using free\n");
		break;
	case 2:
		/*
		* Memory allocation with HeapAlloc
		* * https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapalloc
		*/
		pAddress = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, 100); 
		memcpy(pAddress, cString, strlen(cString)); 
		info("Address allocated with HeapAlloc: 0x%p\n", pAddress);
		printf(pAddress); 

		HeapFree(GetProcessHeap(), HEAP_ZERO_MEMORY, pAddress);
		info("Memory deallocated using HeapFree\n");
		break; 
	case 3: 
		/*
		* Memory allocation with LocalAlloc
		* * https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-localalloc
		*/
		pAddress = LocalAlloc(LPTR, 100);
		memcpy(pAddress, cString, strlen(cString));
		info("Address allocated with LocalAlloc: 0x%p\n", pAddress);
		printf(pAddress);
		
		// Zero out memory before freeing the allocated space
		// ZeroMemory(pAddress, 100); 
		LocalFree(pAddress);
		info("Memory deallocated using LocalFree\n");
		break; 
	case 4:
		/* 
		* Memory allocation with VirtualAlloc
		* * https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc
		*/
		pAddress = VirtualAlloc(NULL, 100, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
		memcpy(pAddress, cString, strlen(cString)); 
		info("Address allocated with VirtualAlloc: 0x%p\n", pAddress);
		printf(pAddress);

		VirtualFree(pAddress, 0, MEM_RELEASE);
		info("Memory deallocated using VirtualFree\n");
		break;

		break; 
	default:
		warn("Invalid mode."); 
		break; 
	}
	
	return 0; 
}